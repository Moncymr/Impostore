@page "/game"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject GameService GameService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Partita - Impostore</PageTitle>

<div class="game-container">
    @if (isLoading)
    {
        <div class="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
            <p>Caricamento partita...</p>
        </div>
    }
    else if (game == null || currentPlayer == null)
    {
        <div class="error-container">
            <h2>‚ö†Ô∏è Errore</h2>
            <p>Partita non trovata</p>
            <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/")'>
                Torna alla Home
            </button>
        </div>
    }
    else
    {
        <div class="game-layout">
            <div class="game-header">
                <h1>üé≠ Impostore - @currentPlayer?.Nickname</h1>
                <div class="game-info">
                    <span class="game-code">Codice: @game.Code</span>
                    <span class="game-state">@GetStateLabel()</span>
                </div>
            </div>

            <div class="game-main">
                <div class="game-content">
                    @* Always show role card once game has started *@
                    @if (game.State != GameState.Lobby && currentPlayer != null)
                    {
                        <div class="secret-card">
                            @if (currentPlayer.IsImpostor)
                            {
                                <div class="impostor-card">
                                    <h2>üé≠ SEI L'IMPOSTORE!</h2>
                                    <p>Non conosci la parola segreta. Cerca di non farti scoprire!</p>
                                    @if (!string.IsNullOrEmpty(game.WordHint))
                                    {
                                        <div class="hint-box">
                                            <h3>üí° Suggerimento:</h3>
                                            <p class="hint-text">@game.WordHint</p>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="word-card">
                                    <h2>üîë La Parola Segreta √®:</h2>
                                    <h1 class="secret-word">@game.SecretWord</h1>
                                    <p>Non dire la parola esatta, ma dai indizi!</p>
                                </div>
                            }
                        </div>
                    }

                    @if (game.State == GameState.InProgress)
                    {
                        <div class="turn-section">
                            <h3>Fase Turni</h3>
                            <p>√à il turno di: <strong>@GetCurrentTurnPlayer()?.Nickname</strong></p>
                            
                            @* Show pass button to current turn player *@
                            @if (GetCurrentTurnPlayer()?.Id == currentPlayer?.Id)
                            {
                                <button class="btn btn-secondary btn-lg" @onclick="PassTurn">
                                    ‚è≠Ô∏è Passa il Turno
                                </button>
                                <p class="text-muted mt-2"><small>Scrivi un messaggio o passa il turno senza scrivere</small></p>
                            }
                            
                            @* Ready to vote button - available to all players *@
                            <div class="mt-3 ready-to-vote-section">
                                <h4>Pronto a Votare?</h4>
                                @if (!currentPlayer.IsReadyToVote)
                                {
                                    <button class="btn btn-success btn-lg" @onclick="DeclareReady">
                                        ‚úã Sono Pronto a Votare
                                    </button>
                                }
                                else
                                {
                                    <p class="ready-message">‚úì Sei pronto! In attesa degli altri giocatori...</p>
                                }
                                
                                <div class="ready-status mt-3">
                                    <p>Giocatori pronti: @game.Players.Count(p => p.IsApproved && p.IsReadyToVote) / @game.Players.Count(p => p.IsApproved)</p>
                                    <div class="ready-list">
                                        @foreach (var player in game.Players.Where(p => p.IsApproved))
                                        {
                                            <span class="player-ready-badge @(player.IsReadyToVote ? "ready" : "not-ready")">
                                                @player.Nickname @(player.IsReadyToVote ? "‚úì" : "‚è≥")
                                            </span>
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            @* Host controls - Always visible and prominent *@
                            @if (isHost)
                            {
                                <div class="mt-3 host-controls">
                                    <button class="btn btn-primary" @onclick="NextTurn">
                                        ‚û°Ô∏è Turno Successivo
                                    </button>
                                    <button class="btn btn-warning ms-2" @onclick="StartVotingManually">
                                        üó≥Ô∏è Inizia Votazione
                                    </button>
                                </div>
                            }
                        </div>
                    }

                    @if (game.State == GameState.Voting)
                    {
                        <div class="voting-section">
                            <h3>üó≥Ô∏è Votazione</h3>
                            @if (!hasVoted)
                            {
                                <p>Seleziona chi pensi sia l'impostore:</p>
                                <div class="name-voting-select">
                                    <select class="form-select form-select-lg" 
                                            @bind="votePlayerName">
                                        <option value="">-- Seleziona un giocatore --</option>
                                        @foreach (var player in game.Players.Where(p => p.IsApproved && p.Id != currentPlayer?.Id))
                                        {
                                            <option value="@player.Nickname">@player.Nickname</option>
                                        }
                                    </select>
                                    <button class="btn btn-primary btn-lg mt-3 w-100" 
                                            @onclick="CastVoteByName"
                                            disabled="@(string.IsNullOrWhiteSpace(votePlayerName))">
                                        üó≥Ô∏è Vota
                                    </button>
                                </div>
                            }
                            else
                            {
                                <p class="voted-message">‚úì Hai votato per: <strong>@votedPlayerName</strong></p>
                                <p>In attesa degli altri...</p>
                                <p>Voti ricevuti: @game.Votes.Count / @game.Players.Count(p => p.IsApproved)</p>
                            }
                        </div>
                    }

                    @if (game.State == GameState.Finished)
                    {
                        <div class="results-section">
                            <h2>üèÜ Partita Finita!</h2>
                            @if (game.ImpostorsWon)
                            {
                                <div class="impostor-wins">
                                    <h3>L'Impostore Ha Vinto!</h3>
                                    <p>L'impostore era: <strong>@GetPlayerById(game.ImpostorId)?.Nickname</strong></p>
                                    <p>La parola segreta era: <strong>@game.SecretWord</strong></p>
                                </div>
                            }
                            else
                            {
                                <div class="players-win">
                                    <h3>I Giocatori Hanno Vinto!</h3>
                                    <p>L'impostore era: <strong>@GetPlayerById(game.ImpostorId)?.Nickname</strong></p>
                                    <p>Giocatore pi√π votato: <strong>@GetPlayerById(game.WinnerId)?.Nickname</strong></p>
                                    <p>La parola segreta era: <strong>@game.SecretWord</strong></p>
                                </div>
                            }
                            
                            <div class="game-end-actions mt-4">
                                @if (isHost)
                                {
                                    <button class="btn btn-success btn-lg me-2" @onclick="StartRematch">
                                        üîÑ Nuova Partita
                                    </button>
                                }
                                else
                                {
                                    <p class="text-muted">In attesa che l'host inizi una nuova partita...</p>
                                }
                                <button class="btn btn-outline-secondary mt-2" @onclick='() => Navigation.NavigateTo("/")'>
                                    üè† Torna alla Home
                                </button>
                            </div>
                        </div>
                    }
                </div>

                <div class="chat-section">
                    <div class="chat-header">
                        <h3>üí¨ Chat</h3>
                    </div>
                    <div class="chat-messages" @ref="chatContainer">
                        @foreach (var message in game.Messages.OrderBy(m => m.Timestamp))
                        {
                            <div class="chat-message @(message.IsSystemMessage ? "system" : "")">
                                <span class="message-author">@message.PlayerName:</span>
                                <span class="message-text">@message.Message</span>
                                <span class="message-time">@message.Timestamp.ToString("HH:mm")</span>
                            </div>
                        }
                    </div>
                    <div class="chat-input">
                        <input type="text" 
                               class="form-control" 
                               @bind="messageInput" 
                               @bind:event="oninput"
                               @onkeydown="HandleKeyDown"
                               placeholder="@GetChatPlaceholder()"
                               disabled="@(!CanSendMessage())" />
                        <button class="btn btn-primary" 
                                @onclick="SendMessage"
                                disabled="@(string.IsNullOrWhiteSpace(messageInput) || !CanSendMessage())">
                            Invia
                        </button>
                    </div>
                </div>
            </div>

            <div class="players-sidebar">
                <h3>üë• Giocatori (@game.Players.Count(p => p.IsApproved))</h3>
                <div class="players-list">
                    @foreach (var player in game.Players.Where(p => p.IsApproved))
                    {
                        <div class="player-item @(player.Id == currentPlayer.Id ? "current" : "")">
                            <span class="player-name">@player.Nickname</span>
                            @if (player.IsHost)
                            {
                                <span class="badge host">Host</span>
                            }
                            @if (game.State == GameState.Finished && player.Id == game.ImpostorId)
                            {
                                <span class="badge impostor">Impostore</span>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private HubConnection? hubConnection;
    private Game? game;
    private Player? currentPlayer;
    private string gameId = "";
    private string playerId = "";
    private bool isHost = false;
    private bool isLoading = true;
    private string messageInput = "";
    private bool hasVoted = false;
    private string votePlayerName = "";
    private string votedPlayerName = "";
    private ElementReference chatContainer;

    protected override async Task OnInitializedAsync()
    {
        gameId = Navigation.GetQueryParameter("gameId") ?? "";
        playerId = Navigation.GetQueryParameter("playerId") ?? "";

        if (string.IsNullOrEmpty(gameId) || string.IsNullOrEmpty(playerId))
        {
            Navigation.NavigateTo("/");
            return;
        }

        try
        {
            game = await GameService.GetGameByIdAsync(gameId);
            if (game == null)
            {
                isLoading = false;
                return;
            }

            currentPlayer = game.Players.FirstOrDefault(p => p.Id == playerId);
            if (currentPlayer == null)
            {
                isLoading = false;
                return;
            }

            isHost = currentPlayer.IsHost;
            hasVoted = game.Votes.Any(v => v.VoterId == playerId);

            await InitializeSignalR();
            
            // After SignalR is initialized, refresh game state to ensure we have latest
            game = await GameService.GetGameByIdAsync(gameId);
            currentPlayer = game.Players.FirstOrDefault(p => p.Id == playerId);
            
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
        catch
        {
            isLoading = false;
        }
    }

    private async Task InitializeSignalR()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<Game>("GameUpdated", async (updatedGame) =>
        {
            game = updatedGame;
            currentPlayer = game.Players.FirstOrDefault(p => p.Id == playerId);
            await InvokeAsync(StateHasChanged);
        });

        hubConnection.On<ChatMessage>("ReceiveMessage", async (message) =>
        {
            if (game != null)
            {
                game = await GameService.GetGameByIdAsync(gameId);
                currentPlayer = game.Players.FirstOrDefault(p => p.Id == playerId);
                await InvokeAsync(StateHasChanged);
                
                // Auto-scroll chat to bottom after message received
                await ScrollChatToBottom();
            }
        });

        hubConnection.On<Game>("VotingStarted", async (updatedGame) =>
        {
            game = updatedGame;
            currentPlayer = game.Players.FirstOrDefault(p => p.Id == playerId);
            await InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string>("VoteCast", async (voterId) =>
        {
            if (game != null)
            {
                game = await GameService.GetGameByIdAsync(gameId);
                currentPlayer = game.Players.FirstOrDefault(p => p.Id == playerId);
                await InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<Game>("GameFinished", async (updatedGame) =>
        {
            game = updatedGame;
            currentPlayer = game.Players.FirstOrDefault(p => p.Id == playerId);
            await InvokeAsync(StateHasChanged);
        });

        hubConnection.On<string, string>("TurnChanged", async (turnPlayerId, turnPlayerNickname) =>
        {
            // Refresh game state to ensure we have the latest turn information
            if (game != null)
            {
                game = await GameService.GetGameByIdAsync(gameId);
                currentPlayer = game.Players.FirstOrDefault(p => p.Id == playerId);
                await InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<string>("PlayerReadyUpdated", async (readyPlayerId) =>
        {
            // Refresh game state when a player declares ready
            if (game != null)
            {
                game = await GameService.GetGameByIdAsync(gameId);
                currentPlayer = game.Players.FirstOrDefault(p => p.Id == playerId);
                await InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<Game>("GameStarted", async (updatedGame) =>
        {
            // Game has started, refresh full game state
            game = updatedGame;
            currentPlayer = game.Players.FirstOrDefault(p => p.Id == playerId);
            await InvokeAsync(StateHasChanged);
        });

        hubConnection.On<Game>("RematchStarted", async (updatedGame) =>
        {
            // Game has been reset for a rematch
            game = updatedGame;
            currentPlayer = game.Players.FirstOrDefault(p => p.Id == playerId);
            hasVoted = false;
            votedPlayerName = "";
            votePlayerName = "";
            await InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
        await hubConnection.SendAsync("JoinGameGroup", gameId);
        await hubConnection.SendAsync("UpdatePlayerConnection", playerId, gameId, true);
    }

    private async Task SendMessage()
    {
        if (hubConnection != null && !string.IsNullOrWhiteSpace(messageInput))
        {
            await hubConnection.SendAsync("SendMessage", gameId, playerId, messageInput);
            messageInput = "";
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }

    private async Task NextTurn()
    {
        if (hubConnection != null)
        {
            await hubConnection.SendAsync("NextTurn", gameId);
        }
    }

    private async Task PassTurn()
    {
        if (hubConnection != null)
        {
            await hubConnection.SendAsync("NextTurn", gameId);
        }
    }

    private async Task StartVotingManually()
    {
        if (hubConnection != null)
        {
            await hubConnection.SendAsync("StartVoting", gameId);
        }
    }

    private async Task DeclareReady()
    {
        if (hubConnection != null && currentPlayer != null)
        {
            await hubConnection.SendAsync("SetPlayerReadyToVote", gameId, playerId);
        }
    }

    private async Task StartVoting()
    {
        if (hubConnection != null)
        {
            await hubConnection.SendAsync("StartVoting", gameId);
        }
    }

    private async Task CastVote(string targetPlayerId)
    {
        if (hubConnection != null && !hasVoted)
        {
            await hubConnection.SendAsync("CastVote", gameId, playerId, targetPlayerId);
            hasVoted = true;
        }
    }

    private async Task CastVoteByName()
    {
        if (hubConnection != null && !hasVoted && !string.IsNullOrWhiteSpace(votePlayerName))
        {
            await hubConnection.SendAsync("CastVoteByName", gameId, playerId, votePlayerName);
            votedPlayerName = votePlayerName;
            hasVoted = true;
            votePlayerName = "";
        }
    }

    private async Task StartRematch()
    {
        if (hubConnection != null && isHost)
        {
            await hubConnection.SendAsync("StartRematch", gameId);
        }
    }

    private Player? GetCurrentTurnPlayer()
    {
        if (game == null) return null;
        var approvedPlayers = game.Players.Where(p => p.IsApproved).ToList();
        if (game.CurrentTurnIndex < approvedPlayers.Count)
        {
            return approvedPlayers[game.CurrentTurnIndex];
        }
        return null;
    }

    private bool CanSendMessage()
    {
        if (game == null || currentPlayer == null)
            return false;

        // Handle each game state explicitly
        switch (game.State)
        {
            case GameState.Lobby:
                // No messages allowed in lobby (should not reach here from gameplay page)
                return false;
            
            case GameState.Starting:
                // No messages allowed during game initialization
                return false;
            
            case GameState.InProgress:
                // During InProgress state (turn-based phase), only the current turn player can send messages
                var currentTurnPlayer = GetCurrentTurnPlayer();
                return currentTurnPlayer?.Id == currentPlayer.Id;
            
            case GameState.Voting:
                // During voting phase, everyone can send messages
                return true;
            
            case GameState.Finished:
                // No messages allowed when game is finished
                return false;
            
            default:
                // Unknown state - disallow messages for safety
                return false;
        }
    }

    private string GetChatPlaceholder()
    {
        if (game == null || currentPlayer == null)
            return "Scrivi un messaggio...";

        switch (game.State)
        {
            case GameState.Lobby:
                return "Attendi l'inizio della partita...";
            
            case GameState.Starting:
                return "La partita sta iniziando...";
            
            case GameState.InProgress:
                var currentTurnPlayer = GetCurrentTurnPlayer();
                if (currentTurnPlayer?.Id == currentPlayer.Id)
                    return "√à il tuo turno! Scrivi il tuo messaggio...";
                else
                    return $"√à il turno di {currentTurnPlayer?.Nickname}. Attendi il tuo turno...";
            
            case GameState.Voting:
                return "Scrivi un messaggio...";
            
            case GameState.Finished:
                return "Partita terminata";
            
            default:
                return "Scrivi un messaggio...";
        }
    }

    private Player? GetPlayerById(string? id)
    {
        return game?.Players.FirstOrDefault(p => p.Id == id);
    }

    private async Task ScrollChatToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollChatToBottom");
        }
        catch
        {
            // Ignore errors if JS isn't ready
        }
    }

    private string GetStateLabel()
    {
        return game?.State switch
        {
            GameState.Lobby => "In Attesa",
            GameState.InProgress => "In Corso - Turni",
            GameState.Voting => "Votazione",
            GameState.Finished => "Finita",
            _ => "Sconosciuto"
        };
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.SendAsync("UpdatePlayerConnection", playerId, gameId, false);
            await hubConnection.DisposeAsync();
        }
    }
}

<script>
    window.scrollChatToBottom = function() {
        const chatMessages = document.querySelector('.chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    };
</script>
