@page "/lobby"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject GameService GameService
@implements IAsyncDisposable

<PageTitle>Lobby - Impostore</PageTitle>

<div class="lobby-container">
    @if (isLoading)
    {
        <div class="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
            <p>Caricamento...</p>
        </div>
    }
    else if (game == null)
    {
        <div class="error-container">
            <h2>‚ö†Ô∏è Errore</h2>
            <p>@errorMessage</p>
            <button type="button" class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/")'>
                Torna alla Home
            </button>
        </div>
    }
    else
    {
        <div class="lobby-card">
            <h1>üéÆ Lobby Partita</h1>
            <div class="game-code">
                <h2>Codice: <span class="code">@game.Code</span></h2>
                <p class="code-info">Condividi questo codice con i tuoi amici!</p>
            </div>

            <div class="players-section">
                <h3>üë• Giocatori (@(approvedPlayers.Count + pendingPlayers.Count))</h3>
                <div class="players-list">
                    @foreach (var player in approvedPlayers)
                    {
                        <div class="player-item approved">
                            <span class="player-avatar">@player.Avatar</span>
                            <span class="player-name">@player.Nickname</span>
                            @if (player.IsHost)
                            {
                                <span class="badge">Host</span>
                            }
                        </div>
                    }
                    @foreach (var player in pendingPlayers)
                    {
                        <div class="player-item pending">
                            <span class="player-avatar">@player.Avatar</span>
                            <span class="player-name">@player.Nickname</span>
                            <span class="badge">In Attesa</span>
                            @if (isHost)
                            {
                                <div class="actions">
                                    <button type="button" class="btn btn-sm btn-success" @onclick="() => ApprovePlayer(player.Id)">
                                        ‚úì Accetta
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" @onclick="() => RejectPlayer(player.Id)">
                                        ‚úó Rifiuta
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="alert alert-info">@statusMessage</div>
            }

            <div class="lobby-actions">
                @if (isHost)
                {
                    <button type="button" 
                            class="btn btn-success btn-lg" 
                            @onclick="StartGame"
                            disabled="@(approvedPlayers.Count < 3)">
                        üöÄ Inizia Partita
                    </button>
                    @if (approvedPlayers.Count < 3)
                    {
                        <p class="text-muted mt-2">Minimo 3 giocatori per iniziare</p>
                    }
                }
                else
                {
                    @if (!currentPlayer?.IsApproved ?? false)
                    {
                        <p class="waiting-approval">In attesa di approvazione dall'host...</p>
                    }
                    else
                    {
                        <p class="waiting-start">In attesa che l'host inizi la partita...</p>
                    }
                }
            </div>
        </div>
    }
</div>

@code {
    private HubConnection? hubConnection;
    private Game? game;
    private Player? currentPlayer;
    private string nickname = "";
    private string playerId = Guid.NewGuid().ToString();
    private string gameId = "";
    private bool isHost = false;
    private bool isLoading = true;
    private bool isInitialized = false;
    private string errorMessage = "";
    private string statusMessage = "";

    private List<Player> approvedPlayers => game?.Players.Where(p => p.IsApproved).ToList() ?? new();
    private List<Player> pendingPlayers => game?.Players.Where(p => !p.IsApproved).ToList() ?? new();

    protected override async Task OnInitializedAsync()
    {
        // Prevent double initialization
        if (isInitialized)
            return;
        
        isInitialized = true;
        nickname = Navigation.GetQueryParameter("nickname") ?? "";
        var avatar = Navigation.GetQueryParameter("avatar") ?? "üòÄ";
        var createGame = Navigation.GetQueryParameter("create") == "true";
        var gameCode = Navigation.GetQueryParameter("code");

        if (string.IsNullOrEmpty(nickname))
        {
            Navigation.NavigateTo("/");
            return;
        }

        try
        {
            if (createGame)
            {
                game = await GameService.CreateGameAsync(playerId, nickname, avatar);
                gameId = game.Id;
                isHost = true;
                currentPlayer = game.Players.First();
            }
            else if (!string.IsNullOrEmpty(gameCode))
            {
                game = await GameService.GetGameByCodeAsync(gameCode);
                if (game == null)
                {
                    errorMessage = "Partita non trovata";
                    isLoading = false;
                    return;
                }
                
                gameId = game.Id;
                var (player, isNewPlayer) = await GameService.AddPlayerToGameAsync(game.Id, playerId, nickname, avatar);
                currentPlayer = player;
                
                if (currentPlayer == null)
                {
                    errorMessage = "Impossibile unirsi alla partita";
                    isLoading = false;
                    return;
                }
                
                // Use the returned player's ID (in case an existing player was returned)
                playerId = currentPlayer.Id;
                
                game = await GameService.GetGameByIdAsync(game.Id);
                
                // Store whether this is a new player to avoid duplicate notifications
                await InitializeSignalR();
                
                // Notify the host about the new player joining (only if this is a truly new player)
                if (!isHost && hubConnection != null && currentPlayer != null && !string.IsNullOrEmpty(gameId) && isNewPlayer)
                {
                    await hubConnection.SendAsync("NotifyPlayerJoined", gameId, playerId, nickname);
                }
            }
            else
            {
                errorMessage = "Parametri mancanti";
                isLoading = false;
                return;
            }

            if (isHost)
            {
                await InitializeSignalR();
            }
            
            isLoading = false;
        }
        catch (Exception ex)
        {
            errorMessage = $"Errore: {ex.Message}";
            isLoading = false;
        }
    }

    private async Task InitializeSignalR()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<Player>("PlayerJoinRequest", async (player) =>
        {
            if (!string.IsNullOrEmpty(gameId))
            {
                game = await GameService.GetGameByIdAsync(gameId);
                await InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<string>("PlayerApproved", async (approvedPlayerId) =>
        {
            if (!string.IsNullOrEmpty(gameId))
            {
                game = await GameService.GetGameByIdAsync(gameId);
                if (approvedPlayerId == playerId)
                {
                    statusMessage = "Sei stato approvato dall'host!";
                }
                await InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<string>("PlayerRejected", async (rejectedPlayerId) =>
        {
            if (rejectedPlayerId == playerId)
            {
                errorMessage = "La tua richiesta √® stata rifiutata";
                await InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<Game>("GameStarted", async (updatedGame) =>
        {
            if (!string.IsNullOrEmpty(gameId))
            {
                // Small delay to ensure database is fully updated before navigating
                await Task.Delay(500);
                Navigation.NavigateTo($"/game?gameId={gameId}&playerId={playerId}", forceLoad: true);
            }
        });

        hubConnection.On<Game>("GameUpdated", async (updatedGame) =>
        {
            game = updatedGame;
            await InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
        
        if (!string.IsNullOrEmpty(gameId))
        {
            await hubConnection.SendAsync("JoinGameGroup", gameId);
            await hubConnection.SendAsync("UpdatePlayerConnection", playerId, gameId, true);
        }
    }

    private async Task ApprovePlayer(string playerIdToApprove)
    {
        if (hubConnection != null && !string.IsNullOrEmpty(gameId))
        {
            await hubConnection.SendAsync("ApprovePlayer", gameId, playerIdToApprove);
        }
    }

    private async Task RejectPlayer(string playerIdToReject)
    {
        if (hubConnection != null && !string.IsNullOrEmpty(gameId))
        {
            await hubConnection.SendAsync("RejectPlayer", gameId, playerIdToReject);
            game = await GameService.GetGameByIdAsync(gameId);
        }
    }

    private async Task StartGame()
    {
        if (hubConnection != null && !string.IsNullOrEmpty(gameId))
        {
            await hubConnection.SendAsync("StartGame", gameId);
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null && !string.IsNullOrEmpty(gameId))
        {
            try
            {
                await hubConnection.SendAsync("UpdatePlayerConnection", playerId, gameId, false);
            }
            catch
            {
                // Ignore errors during disposal
            }
            finally
            {
                await hubConnection.DisposeAsync();
            }
        }
        else if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
