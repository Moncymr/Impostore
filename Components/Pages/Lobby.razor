@page "/lobby"
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject GameService GameService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Lobby - Impostore</PageTitle>

<div class="lobby-container">
    @if (isLoading)
    {
        <div class="loading">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
            <p>Caricamento...</p>
        </div>
    }
    else if (game == null)
    {
        <div class="error-container">
            <h2>‚ö†Ô∏è Errore</h2>
            <p>@errorMessage</p>
            <button type="button" class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/")'>
                Torna alla Home
            </button>
        </div>
    }
    else
    {
        <div class="lobby-card">
            <h1>üéÆ Lobby Partita</h1>
            <div class="game-code">
                <h2>Codice: <span class="code">@game.Code</span></h2>
                <button class="btn btn-outline-primary btn-sm mt-2" @onclick="CopyGameCode">
                    üìã Copia Codice
                </button>
                @if (codeCopied)
                {
                    <span class="text-success ms-2">‚úì Copiato!</span>
                }
                <p class="code-info mt-2">Condividi questo codice con i tuoi amici!</p>
            </div>

            <div class="players-section">
                <h3>üë• Giocatori (@(approvedPlayers.Count + pendingPlayers.Count))</h3>
                <div class="players-list">
                    @foreach (var player in approvedPlayers)
                    {
                        <div class="player-item approved">
                            <span class="player-avatar">@player.Avatar</span>
                            <span class="player-name">@player.Nickname</span>
                            @if (player.IsHost)
                            {
                                <span class="badge">Host</span>
                            }
                        </div>
                    }
                    @foreach (var player in pendingPlayers)
                    {
                        <div class="player-item pending">
                            <span class="player-avatar">@player.Avatar</span>
                            <span class="player-name">@player.Nickname</span>
                            <span class="badge">In Attesa</span>
                            @if (isHost)
                            {
                                <div class="actions">
                                    <button type="button" class="btn btn-sm btn-success" @onclick="() => ApprovePlayer(player.Id)">
                                        ‚úì Accetta
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" @onclick="() => RejectPlayer(player.Id)">
                                        ‚úó Rifiuta
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="alert alert-info">@statusMessage</div>
            }

            <div class="lobby-actions">
                @if (isHost)
                {
                    <button type="button" 
                            class="btn btn-success btn-lg" 
                            @onclick="StartGame"
                            disabled="@(approvedPlayers.Count < 3)">
                        üöÄ Inizia Partita
                    </button>
                    @if (approvedPlayers.Count < 3)
                    {
                        <div class="alert alert-warning mt-3" role="alert">
                            <strong>‚ö†Ô∏è Attenzione:</strong> Servono almeno <strong>3 giocatori</strong> approvati per iniziare.
                            <br><small>Giocatori attuali: @approvedPlayers.Count</small>
                        </div>
                    }
                    else
                    {
                        <p class="text-success mt-2">‚úì Pronti per iniziare! (@approvedPlayers.Count giocatori)</p>
                    }
                }
                else
                {
                    @if (!currentPlayer?.IsApproved ?? false)
                    {
                        <p class="waiting-approval">In attesa di approvazione dall'host...</p>
                    }
                    else
                    {
                        <p class="waiting-start">In attesa che l'host inizi la partita...</p>
                    }
                }
            </div>
        </div>
    }
</div>

@code {
    private HubConnection? hubConnection;
    private Game? game;
    private Player? currentPlayer;
    private string nickname = "";
    private string playerId = Guid.NewGuid().ToString();
    private string gameId = "";
    private bool isHost = false;
    private bool isLoading = true;
    private bool isInitialized = false;
    private string errorMessage = "";
    private string statusMessage = "";
    private System.Threading.Timer? refreshTimer;
    private bool isRefreshing = false;
    private bool codeCopied = false;

    private List<Player> approvedPlayers => game?.Players.Where(p => p.IsApproved).ToList() ?? new();
    private List<Player> pendingPlayers => game?.Players.Where(p => !p.IsApproved).ToList() ?? new();

    protected override async Task OnInitializedAsync()
    {
        // Prevent double initialization
        if (isInitialized)
            return;
        
        isInitialized = true;
        nickname = Navigation.GetQueryParameter("nickname") ?? "";
        var avatar = Navigation.GetQueryParameter("avatar") ?? "üòÄ";
        var createGame = Navigation.GetQueryParameter("create") == "true";
        var gameCode = Navigation.GetQueryParameter("code");

        if (string.IsNullOrEmpty(nickname))
        {
            Navigation.NavigateTo("/");
            return;
        }

        try
        {
            if (createGame)
            {
                game = await GameService.CreateGameAsync(playerId, nickname, avatar);
                gameId = game.Id;
                isHost = true;
                currentPlayer = game.Players.First();
            }
            else if (!string.IsNullOrEmpty(gameCode))
            {
                game = await GameService.GetGameByCodeAsync(gameCode);
                if (game == null)
                {
                    errorMessage = "Partita non trovata";
                    isLoading = false;
                    return;
                }
                
                gameId = game.Id;
                var (player, isNewPlayer) = await GameService.AddPlayerToGameAsync(game.Id, playerId, nickname, avatar);
                currentPlayer = player;
                
                if (currentPlayer == null)
                {
                    errorMessage = "Impossibile unirsi alla partita";
                    isLoading = false;
                    return;
                }
                
                // Use the returned player's ID (in case an existing player was returned)
                playerId = currentPlayer.Id;
                
                game = await GameService.GetGameByIdAsync(game.Id);
                
                // Store whether this is a new player to avoid duplicate notifications
                await InitializeSignalR();
                
                // Notify the host about the new player joining (only if this is a truly new player)
                if (!isHost && hubConnection != null && currentPlayer != null && !string.IsNullOrEmpty(gameId) && isNewPlayer)
                {
                    await hubConnection.SendAsync("NotifyPlayerJoined", gameId, playerId, nickname);
                }
            }
            else
            {
                errorMessage = "Parametri mancanti";
                isLoading = false;
                return;
            }

            if (isHost)
            {
                await InitializeSignalR();
                StartRefreshTimer();
            }
            
            isLoading = false;
        }
        catch (Exception ex)
        {
            errorMessage = $"Errore: {ex.Message}";
            isLoading = false;
        }
    }

    private async Task InitializeSignalR()
    {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/gamehub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<Player>("PlayerJoinRequest", async (player) =>
        {
            if (!string.IsNullOrEmpty(gameId))
            {
                game = await GameService.GetGameByIdAsync(gameId);
                await InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<string>("PlayerApproved", async (approvedPlayerId) =>
        {
            if (!string.IsNullOrEmpty(gameId))
            {
                game = await GameService.GetGameByIdAsync(gameId);
                if (approvedPlayerId == playerId)
                {
                    statusMessage = "Sei stato approvato dall'host!";
                }
                await InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<string>("PlayerRejected", async (rejectedPlayerId) =>
        {
            if (rejectedPlayerId == playerId)
            {
                errorMessage = "La tua richiesta √® stata rifiutata";
                await InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<Game>("GameStarted", async (updatedGame) =>
        {
            if (!string.IsNullOrEmpty(gameId))
            {
                // Small delay to ensure database is fully updated before navigating
                await Task.Delay(500);
                Navigation.NavigateTo($"/game?gameId={gameId}&playerId={playerId}", forceLoad: true);
            }
        });

        hubConnection.On<Game>("GameUpdated", async (updatedGame) =>
        {
            game = updatedGame;
            await InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
        
        if (!string.IsNullOrEmpty(gameId))
        {
            await hubConnection.SendAsync("JoinGameGroup", gameId);
            await hubConnection.SendAsync("UpdatePlayerConnection", playerId, gameId, true);
        }
    }

    private async Task ApprovePlayer(string playerIdToApprove)
    {
        if (hubConnection != null && !string.IsNullOrEmpty(gameId))
        {
            await hubConnection.SendAsync("ApprovePlayer", gameId, playerIdToApprove);
            game = await GameService.GetGameByIdAsync(gameId);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task RejectPlayer(string playerIdToReject)
    {
        if (hubConnection != null && !string.IsNullOrEmpty(gameId))
        {
            await hubConnection.SendAsync("RejectPlayer", gameId, playerIdToReject);
            game = await GameService.GetGameByIdAsync(gameId);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task StartGame()
    {
        if (hubConnection != null && !string.IsNullOrEmpty(gameId))
        {
            await hubConnection.SendAsync("StartGame", gameId);
        }
    }

    private async Task CopyGameCode()
    {
        if (game != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", game.Code);
                codeCopied = true;
                StateHasChanged();
                
                // Reset the "copied" message after 2 seconds
                await Task.Delay(2000);
                codeCopied = false;
                StateHasChanged();
            }
            catch
            {
                // Clipboard API not available or permission denied - silently fail
                // The user can still manually copy the code
            }
        }
    }

    private void StartRefreshTimer()
    {
        // Only start timer for host in lobby
        if (isHost && game?.State == GameState.Lobby)
        {
            refreshTimer = new System.Threading.Timer(_ =>
            {
                // Use Task.Run to avoid blocking and handle async properly
                _ = Task.Run(async () =>
                {
                    try
                    {
                        await RefreshGameState();
                    }
                    catch
                    {
                        // Ignore errors in background refresh
                    }
                });
            }, null, TimeSpan.FromSeconds(3), TimeSpan.FromSeconds(3));
        }
    }

    private async Task RefreshGameState()
    {
        // Prevent concurrent executions
        if (isRefreshing || string.IsNullOrEmpty(gameId) || !isHost || game?.State != GameState.Lobby)
            return;

        try
        {
            isRefreshing = true;
            var updatedGame = await GameService.GetGameByIdAsync(gameId);
            if (updatedGame != null)
            {
                game = updatedGame;
                await InvokeAsync(StateHasChanged);
            }
        }
        finally
        {
            isRefreshing = false;
        }
    }

    public async ValueTask DisposeAsync()
    {
        // Dispose the refresh timer
        if (refreshTimer != null)
        {
            await refreshTimer.DisposeAsync();
            refreshTimer = null;
        }

        if (hubConnection != null && !string.IsNullOrEmpty(gameId))
        {
            try
            {
                await hubConnection.SendAsync("UpdatePlayerConnection", playerId, gameId, false);
            }
            catch
            {
                // Ignore errors during disposal
            }
            finally
            {
                await hubConnection.DisposeAsync();
            }
        }
        else if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }
}
